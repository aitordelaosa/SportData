services:
  mongo:
    image: mongo:6
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: sportdata_usuarios
    volumes:
      - mongo_data:/data/db
    ports:
      - "127.0.0.1:27018:27017"

  user-service:
    build:
      context: ./microservicioUsuarios
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4001
      MONGO_URI: mongodb://mongo:27017/sportdata_usuarios
      JWT_SECRET: ${JWT_SECRET:-sportdata-dev-secret}
    depends_on:
      - mongo
    ports:
      - "127.0.0.1:4001:4001"

  api-gateway:
    build:
      context: ./api-gateway
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      USER_SERVICE_URL: http://user-service:4001/api
      PRODUCT_SERVICE_URL: http://product-service:8002
      ORDER_SERVICE_URL: http://orders-service:7000
      JWT_SECRET: ${JWT_SECRET:-sportdata-dev-secret}
    depends_on:
      - user-service
      - product-service
      - orders-service
    ports:
      - "127.0.0.1:5000:5000"

  products-db:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: sport4data
      POSTGRES_USER: sport4data
      POSTGRES_PASSWORD: sport4data
    volumes:
      - products_pgdata:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"

  product-service:
    build:
      context: ./microservicioProductos
    restart: unless-stopped
    environment:
      PRODUCTS_DATABASE_URL: postgresql+psycopg://sport4data:sport4data@products-db:5432/sport4data
      PRODUCTS_STATIC_DIR: /app/static
      # Usamos 127.0.0.1 para evitar problemas de resoluci√≥n IPv6 con "localhost"
      PRODUCTS_STATIC_BASE_URL: http://127.0.0.1:8002/static
    depends_on:
      - products-db
    volumes:
      - ./static:/app/static:ro
    ports:
      - "127.0.0.1:8002:8002"

  orders-db:
    image: mongo:6
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: sportdata_orders
    volumes:
      - orders_data:/data/db
    ports:
      - "127.0.0.1:27019:27017"

  orders-service:
    build:
      context: ./microservicioPedidos
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 7000
      ORDERS_MONGO_URI: mongodb://orders-db:27017/sportdata_orders
      PRODUCT_SERVICE_URL: http://product-service:8002
      JWT_SECRET: ${JWT_SECRET:-sportdata-dev-secret}
    depends_on:
      - orders-db
      - product-service
    ports:
      - "127.0.0.1:7000:7000"

  frontend:
    image: nginx:alpine
    restart: unless-stopped
    volumes:
      - ./web:/usr/share/nginx/html:ro
    ports:
      # Fijamos el bind a IPv4 para que "localhost" resuelva sin resets en Windows/WSL2
      - "127.0.0.1:8080:80"
    depends_on:
      - api-gateway

volumes:
  mongo_data:
  products_pgdata:
  orders_data:
